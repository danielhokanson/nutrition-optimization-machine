<div class="nom-page-container">
  <mat-card class="nom-card">
    <mat-card-header class="nom-card__header">
      <mat-card-title class="nom-card__title">
        @if (submitMessage) { Onboarding Complete! } @else { Onboarding:
        {{ currentStepTitle }}
        }
      </mat-card-title>
    </mat-card-header>

    @if (isLoading || isSubmitting) {
    <mat-progress-bar
      mode="indeterminate"
      color="primary"
      class="nom-card__progress-bar"
    ></mat-progress-bar>
    } @if (error && !submitMessage) {
    <mat-card-content class="nom-card__content">
      <div class="nom-form__error form-level-error nom-message-text mb-4">
        {{ error }}
      </div>
    </mat-card-content>
    } @else if (submitMessage) {
    <mat-card-content class="nom-card__content">
      <div
        class="text-center p-4 rounded-md"
        [ngClass]="{
          'bg-green-100 text-green-700': submitMessage.includes('successfully'),
          'bg-red-100 text-red-700': !submitMessage.includes('successfully')
        }"
      >
        <p class="nom-message-text font-semibold">{{ submitMessage }}</p>
        <button
          mat-raised-button
          color="primary"
          (click)="onCompletionRedirect()"
          class="nom-button mt-4"
        >
          Go to Dashboard
        </button>
      </div>
    </mat-card-content>
    } @else {
    <mat-card-content class="nom-card__content">
      <!-- Step 1: Invitation Code -->
      @if (currentStep?.id === 'invitationCode') {
      <div class="nom-section">
        <h3 class="nom-section__heading">Join an Existing Plan (Optional)</h3>
        <p class="nom-instruction-text">
          Do you have an invitation code to join an existing plan?
        </p>
        <mat-form-field
          appearance="outline"
          class="nom-form__field nom-form__field--centered"
        >
          <mat-label>Invitation Code</mat-label>
          <input
            matInput
            type="text"
            [formControl]="invitationCodeFormControl"
            class="nom-form__input"
            placeholder="Enter code"
          />
        </mat-form-field>
        <div class="flex justify-center mt-4">
          <button
            mat-raised-button
            color="primary"
            (click)="onInvitationCodeSubmit()"
            [disabled]="!invitationCodeFormControl.value || isLoading"
            class="nom-button mr-2"
          >
            Join Plan
          </button>
          <button
            mat-raised-button
            color="accent"
            (click)="onNoInvitationCode()"
            [disabled]="isLoading"
            class="nom-button"
          >
            I have no Invitation Code
          </button>
        </div>
      </div>
      }
      <!-- Step 2: Your Details -->
      @else if (currentStep?.id === 'personDetails') {
      <app-person-edit
        [person]="onboardingData.personDetails"
        (formSubmitted)="onPersonDetailsSubmitted($event)"
      ></app-person-edit>
      }
      <!-- Step 3: Additional Participants -->
      @else if (currentStep?.id === 'hasAdditionalParticipants') {
      <div class="nom-section">
        <h3 class="nom-section__heading">Additional Participants</h3>
        <p class="nom-instruction-text">
          Will anyone else be participating in this plan with you (e.g., family
          members, roommates)?
        </p>
        <div class="nom-horizontal-group flex-wrap justify-center my-4">
          <button
            mat-raised-button
            color="primary"
            (click)="onYesNoAnswer('hasAdditionalParticipants', true)"
            class="nom-button mr-2"
          >
            Yes
          </button>
          <button
            mat-raised-button
            color="accent"
            (click)="onYesNoAnswer('hasAdditionalParticipants', false)"
            class="nom-button"
          >
            No
          </button>
        </div>
      </div>
      }
      <!-- Step 4: How Many People? -->
      @else if (currentStep?.id === 'numberOfAdditionalParticipants') {
      <div class="nom-section">
        <h3 class="nom-section__heading">How Many People?</h3>
        <p class="nom-instruction-text">
          How many additional people will be participating?
        </p>
        <mat-form-field
          appearance="outline"
          class="nom-form__field nom-form__field--centered"
        >
          <mat-label>Number of People</mat-label>
          <input
            matInput
            type="number"
            [formControl]="numberOfAdditionalParticipantsControl"
            class="nom-form__input"
            placeholder="Enter a number"
            min="0"
          />
        </mat-form-field>
      </div>
      }
      <!-- Step 5: Participant Names -->
      @else if (currentStep?.id === 'additionalParticipantNames') {
      <div class="nom-section">
        <h3 class="nom-section__heading">Participant Names</h3>
        <p class="nom-instruction-text">
          Enter names for the additional participants.
        </p>
        @for (person of onboardingData.additionalParticipantDetails; let i =
        $index; track i) {
        <mat-form-field appearance="outline" class="nom-form__field">
          <mat-label>Person {{ i + 2 }} Name</mat-label>
          <input
            matInput
            type="text"
            [value]="person.name"
            (input)="updateAdditionalParticipantName(i, $event)"
            class="nom-form__input"
            placeholder="Enter name"
          />
        </mat-form-field>
        }
      </div>
      }
      <!-- Step 6: Health Attributes (Loops per person) -->
      @else if (currentStep?.id === 'healthAttributes') {
      <app-person-health-edit
        [attributes]="
          allPersonsInPlan[currentHealthAttributePersonIndex].attributes || []
        "
        [currentPersonId]="currentHealthAttributesTargetPersonId"
        (formSubmitted)="onHealthAttributesSubmitted($event)"
        (skipStep)="onHealthAttributesSubmitted([])"
      >
      </app-person-health-edit>
      }
      <!-- Step 7: Restriction Scope -->
      @else if (currentStep?.id === 'restrictionScope') {
      <div class="nom-section">
        <h3 class="nom-section__heading">Restriction Scope</h3>
        <p class="nom-instruction-text">
          Will the dietary restrictions and preferences you are about to enter
          apply to the **entire plan** (all participants), or to **specific
          people**?
        </p>
        <mat-radio-group
          aria-label="Restriction Scope"
          [formControl]="restrictionScopeControl"
          class="nom-radio-group"
        >
          <mat-radio-button value="plan" class="nom-radio-button">
            Apply to Entire Plan
          </mat-radio-button>
          <mat-radio-button value="specific" class="nom-radio-button">
            Apply to Specific People
          </mat-radio-button>
        </mat-radio-group>
        @if (restrictionScopeControl.invalid && restrictionScopeControl.touched)
        {
        <p class="nom-form__error">Please select a restriction scope.</p>
        }
      </div>
      }
      <!-- Step 8: Select Affected People -->
      @else if (currentStep?.id === 'selectAffectedPeople') {
      <div class="nom-section">
        <h3 class="nom-section__heading">Select Affected People</h3>
        <p class="nom-instruction-text">
          Select the people this restriction will apply to.
        </p>
        <mat-form-field appearance="outline" class="nom-form__field">
          <mat-label>Affected People</mat-label>
          <mat-select [formControl]="affectedPersonIdsControl" multiple>
            @for (person of allPersonsInPlan; track person.id) {
            <mat-option [value]="person.id">{{ person.name }}</mat-option>
            }
          </mat-select>
        </mat-form-field>
        @if (affectedPersonIdsControl.invalid &&
        affectedPersonIdsControl.touched) {
        <p class="nom-form__error">Please select at least one person.</p>
        }
      </div>
      }
      <!-- Steps 9-11: Restriction Edit (Loops per person if Individual Preferences selected) -->
      @else if (currentStep?.component === 'app-restriction-edit') {
      <app-restriction-edit
        [restrictions]="filteredRestrictionsForCurrentPerson"
        [currentPersonId]="currentRestrictionTargetPersonId"
        [allPersonsInPlan]="allPersonsInPlan"
        [restrictionType]="currentStep.restrictionType"
        [appliesToEntirePlan]="restrictionScopeControl.value === 'plan'"
        [affectedPersonIds]="affectedPersonIdsControl.value || []"
        (formSubmitted)="onRestrictionsSubmitted($event)"
        (skipStep)="skipCurrentStep()"
      >
      </app-restriction-edit>
      }
      <!-- Step 12: Individual Preferences -->
      @else if (currentStep?.id === 'applyIndividualPreferences') {
      <div class="nom-section">
        <h3 class="nom-section__heading">Individual Preferences</h3>
        <p class="nom-instruction-text">
          Should individual preferences be collected for each person
          participating on the plan?
        </p>
        <div class="nom-horizontal-group flex-wrap justify-center my-4">
          <button
            mat-raised-button
            color="primary"
            (click)="
              onYesNoAnswer('applyIndividualPreferencesToEachPerson', true)
            "
            class="nom-button mr-2"
          >
            Yes
          </button>
          <button
            mat-raised-button
            color="accent"
            (click)="
              onYesNoAnswer('applyIndividualPreferencesToEachPerson', false)
            "
            class="nom-button"
          >
            No
          </button>
        </div>
      </div>
      }
      <!-- Step 13: Summary -->
      @else if (currentStep?.id === 'summary') {
      <div class="nom-section">
        <h3 class="nom-section__heading">Review Your Onboarding Details</h3>
        <p class="nom-instruction-text">
          Please review the information you have provided before submitting.
        </p>

        <!-- Summary of Primary Person -->
        @if (onboardingData.personDetails) {
        <mat-card class="nom-card p-4 mb-4">
          <h4 class="text-xl font-semibold text-indigo-700">Your Details:</h4>
          <p class="nom-message-text">
            Name: {{ onboardingData.personDetails.name || 'N/A' }}
          </p>
          @if (onboardingData.personDetails.attributes &&
          onboardingData.personDetails.attributes.length > 0) {
          <h5 class="font-semibold text-indigo-600 mt-2">Health Attributes:</h5>
          @for (attr of onboardingData.personDetails.attributes; track
          attr.attributeTypeRefId) {
          <p class="nom-message-text ml-2">
            {{ attr.attributeTypeRefId }}: {{ attr.value }}
          </p>
          } }
        </mat-card>
        }

        <!-- Summary of Additional Participants & their attributes -->
        @if (onboardingData.hasAdditionalParticipants &&
        onboardingData.additionalParticipantDetails &&
        onboardingData.additionalParticipantDetails.length > 0) {
        <mat-card class="nom-card p-4 mb-4">
          <h4 class="text-xl font-semibold text-indigo-700">
            Additional Participants:
          </h4>
          @for (person of onboardingData.additionalParticipantDetails; track
          person.id || person.name) {
          <p class="nom-message-text">- {{ person.name }}</p>
          @if (person.attributes && person.attributes.length > 0) {
          <h5 class="font-semibold text-indigo-600 ml-2">Health Attributes:</h5>
          @for (attr of person.attributes; track attr.attributeTypeRefId) {
          <p class="nom-message-text ml-4">
            {{ attr.attributeTypeRefId }}: {{ attr.value }}
          </p>
          } } }
        </mat-card>
        }

        <!-- Summary of Restrictions -->
        @if (onboardingData.restrictions && onboardingData.restrictions.length >
        0) {
        <mat-card class="nom-card p-4 mb-4">
          <h4 class="text-xl font-semibold text-indigo-700">Restrictions:</h4>
          @for (res of onboardingData.restrictions; track res.id || res.name) {
          <p class="nom-message-text">
            {{ res.name }}
            @if (res.appliesToEntirePlan) { (Applies to Plan) } @else if
            (res.personId) { (For:
            {{ getPersonName(res.personId, 'Unknown') }}
            ) }
          </p>
          }
        </mat-card>
        }

        <!-- Summary of Plan Invitation Code -->
        @if (onboardingData.planInvitationCode) {
        <mat-card class="nom-card p-4 mb-4">
          <h4 class="text-xl font-semibold text-indigo-700">Joined Plan:</h4>
          <p class="nom-message-text">
            Invitation Code: {{ onboardingData.planInvitationCode }}
          </p>
        </mat-card>
        }
      </div>
      }
    </mat-card-content>
    }

    <!-- Conditional Navigation Buttons -->
    @if (!submitMessage && NO_FLOW_STEPS.indexOf(currentStep?.id) < 0) {
    <mat-card-actions
      class="nom-card__footer flex justify-between items-center px-6 py-4"
    >
      <button
        mat-raised-button
        color="accent"
        (click)="previousStep()"
        [disabled]="currentStepIndex === 0 || isLoading || isSubmitting"
        class="nom-button"
      >
        Previous
      </button>

      @if (isSkippable()) {
      <button
        mat-raised-button
        color="primary"
        (click)="skipCurrentStep()"
        [disabled]="isLoading || isSubmitting"
        class="nom-button"
      >
        Skip
      </button>
      }

      <button
        mat-raised-button
        color="primary"
        (click)="triggerChildComponentSubmission()"
        [disabled]="isLoading || isSubmitting"
        class="nom-button"
      >
        @if (!isSubmitting) {
        <span>{{ isSubmitStep() ? 'Submit Onboarding' : 'Next' }}</span>
        } @else {
        <mat-spinner diameter="20" class="nom-button__spinner"></mat-spinner>
        }
      </button>
    </mat-card-actions>
    }
  </mat-card>
</div>
