<div class="nom-page-container two-factor">
  <mat-card class="nom-card">
    <mat-card-header class="nom-card__header">
      <mat-card-title class="nom-card__title"
        >Two-Factor Authentication (2FA)</mat-card-title
      >
      <mat-card-subtitle class="nom-card__subtitle"
        >Enhance your account security</mat-card-subtitle
      >
    </mat-card-header>
    @if (isLoading) {
    <mat-progress-bar
      mode="indeterminate"
      color="primary"
      class="nom-card__progress-bar"
    ></mat-progress-bar>
    }
    <mat-card-content class="nom-card__content">
      <form
        [formGroup]="twoFactorForm"
        (ngSubmit)="onSubmit()"
        class="nom-form"
      >
        <div class="nom-section two-factor__toggle-section">
          <mat-slide-toggle
            color="primary"
            formControlName="enable"
            class="two-factor__toggle"
          >
            {{
              is2faEnabled
                ? "2FA is CURRENTLY ENABLED"
                : "Enable Two-Factor Authentication"
            }}
          </mat-slide-toggle>
          <p class="nom-message-text">
            {{
              is2faEnabled
                ? "Your account is protected by 2FA. You will need a verification code to log in."
                : "Add an extra layer of security to your account with 2FA."
            }}
          </p>
        </div>

        @if (twoFactorForm.get('enable')?.value) {
        <mat-divider class="nom-divider"></mat-divider>
        <div class="nom-section two-factor__setup-section">
          <h3 class="nom-section__heading">Authenticator App Setup</h3>
          <p class="nom-instruction-text">
            Scan the QR code with your authenticator app (e.g., Google
            Authenticator, Authy) or manually enter the shared key.
          </p>
          <div class="two-factor__qr-and-key-row nom-horizontal-group">
            <div class="two-factor__qr-code-placeholder">
              <img
                src="https://placehold.co/180x180/EEEEEE/333333?text=QR+Code"
                alt="QR Code"
                class="nom-qr-code-image"
              />
            </div>
            <div class="two-factor__shared-key-details nom-section">
              <p class="nom-code-label">Shared Key:</p>
              <div class="nom-code-box">
                <code class="nom-code-text">{{ sharedKey }}</code>
                <button
                  mat-icon-button
                  (click)="copyRecoveryCodes()"
                  matTooltip="Copy Shared Key"
                >
                  <mat-icon>content_copy</mat-icon>
                </button>
              </div>
            </div>
          </div>

          <mat-form-field
            appearance="outline"
            class="nom-form__field nom-form__field--centered"
          >
            <mat-label>Verification Code from App</mat-label>
            <input
              matInput
              type="text"
              formControlName="twoFactorCode"
              required
              maxlength="6"
              pattern="^\d{6}$"
              class="nom-form__input"
            />
            <mat-icon matSuffix class="nom-form__icon">verified_user</mat-icon>
            @if (twoFactorForm.get('twoFactorCode')?.hasError('required')) {
            <mat-error class="nom-form__error">
              Verification code is required.
            </mat-error>
            } @if (twoFactorForm.get('twoFactorCode')?.hasError('pattern')) {
            <mat-error class="nom-form__error">
              Please enter a valid 6-digit code.
            </mat-error>
            }
          </mat-form-field>

          <mat-divider class="nom-divider"></mat-divider>
          <h3 class="nom-section__heading">Recovery Codes</h3>
          <p class="nom-instruction-text">
            Save these recovery codes in a safe place. They can be used to log
            in if you lose access to your authenticator app.
          </p>
          <div class="nom-code-box nom-code-box--dashed nom-horizontal-group">
            @for (code of recoveryCodes; track $index) {
            <span class="nom-code-item">{{ code }}</span>
            }
            <button
              mat-flat-button
              color="accent"
              (click)="copyRecoveryCodes()"
              class="nom-button two-factor__copy-codes-button"
            >
              <mat-icon>content_copy</mat-icon> Copy Codes
            </button>
          </div>
        </div>
        }

        <mat-divider class="nom-divider"></mat-divider>

        <div class="nom-section two-factor__options-section">
          <mat-checkbox
            formControlName="resetSharedKey"
            class="two-factor__option-checkbox"
            [disabled]="!is2faEnabled"
          >
            Reset Authenticator Key (If you lose your app)
          </mat-checkbox>
          <mat-checkbox
            formControlName="resetRecoverCodes"
            class="two-factor__option-checkbox"
            [disabled]="!is2faEnabled"
          >
            Generate New Recovery Codes
          </mat-checkbox>
          <mat-checkbox
            formControlName="forgetMachine"
            class="two-factor__option-checkbox"
          >
            Forget this browser/device for 2FA
          </mat-checkbox>
        </div>

        <button
          mat-raised-button
          color="primary"
          type="submit"
          [disabled]="twoFactorForm.invalid || isLoading"
          class="nom-button"
        >
          @if (!isLoading) {
          <span>{{
            twoFactorForm.get("enable")?.value
              ? "Update 2FA Settings"
              : "Enable 2FA"
          }}</span>
          } @if (isLoading) {
          <mat-spinner
            [diameter]="20"
            class="nom-button__spinner"
          ></mat-spinner>
          }
        </button>
      </form>
    </mat-card-content>
  </mat-card>
</div>
