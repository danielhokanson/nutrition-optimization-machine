<form [formGroup]="restrictionForm" class="nom-form">
  <div class="nom-section">
    <h3 class="nom-section__heading">Restriction Details</h3>
    <p class="nom-instruction-text">
      Please provide details for your
      {{ getRestrictionTypeName(restrictionType!) }} restriction.
    </p>

    <!-- Option to apply to entire plan or specific people -->
    <mat-form-field appearance="outline" class="nom-form__field">
      <mat-label>Applies To</mat-label>
      <mat-select [formControlName]="'appliesToEntirePlan'">
        <mat-option [value]="true">Entire Plan</mat-option>
        <mat-option [value]="false">Specific People</mat-option>
      </mat-select>
    </mat-form-field>

    <!-- Select people if not applies to entire plan -->
    @if (!restrictionForm.get('appliesToEntirePlan')?.value && allPersonsInPlan
    && allPersonsInPlan.length > 1) {
    <mat-form-field appearance="outline" class="nom-form__field">
      <mat-label>Affected People</mat-label>
      <mat-select
        [formControlName]="'affectedPersonIds'"
        multiple
        (selectionChange)="onMultiSelectChange('affectedPersonIds', $event)"
        [value]="affectedPersonIdsArray.value"
      >
        @for (person of allPersonsInPlan; track person.id) {
        <mat-option [value]="person.id">{{ person.name }}</mat-option>
        }
      </mat-select>
    </mat-form-field>
    }

    <!-- Fallback if only one person (the primary user) is in the plan -->
    @if (!restrictionForm.get('appliesToEntirePlan')?.value && allPersonsInPlan
    && allPersonsInPlan.length === 1 && allPersonsInPlan[0].id ===
    currentPersonId) {
    <p class="nom-prompt-text text-center text-gray-600 mt-2">
      This restriction will apply to "You".
    </p>
    }

    <!-- Type-specific sections -->
    @switch (restrictionType) { @case
    (RestrictionTypeEnum.SocietalReligiousEthical) {
    <div class="nom-section mt-4">
      <h4 class="nom-section__subheading">
        Societal/Religious/Ethical Practices
      </h4>
      <p class="nom-instruction-text">
        Select relevant practices and any mandatory inclusions.
      </p>

      <mat-form-field appearance="outline" class="nom-form__field">
        <mat-label>Practice Types</mat-label>
        <mat-select
          [formControlName]="'societalReligiousEthicalTypeIds'"
          multiple
          (selectionChange)="
            onMultiSelectChange('societalReligiousEthicalTypeIds', $event)
          "
          [value]="societalReligiousEthicalTypeIdsArray.value"
        >
          @for (type of societalReligiousEthicalOptions; track type.id) {
          <mat-option [value]="type.id">{{ type.name }}</mat-option>
          }
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline" class="nom-form__field">
        <mat-label>Mandatory Inclusions</mat-label>
        <mat-chip-grid
          #mandatoryInclusionChipGrid
          aria-label="Mandatory Inclusions"
        >
          @for (item of mandatoryInclusionsArray.controls; track item) {
          <mat-chip-row
            (removed)="removeChip(item.value, 'mandatoryInclusions')"
          >
            {{ item.value }}
            <button matChipRemove [attr.aria-label]="'Remove ' + item.value">
              <mat-icon>cancel</mat-icon>
            </button>
          </mat-chip-row>
          }
        </mat-chip-grid>
        <input
          placeholder="New inclusion..."
          [formControl]="ingredientSearchControl"
          [matChipInputFor]="mandatoryInclusionChipGrid"
          [matAutocomplete]="mandatoryInclusionAutocomplete"
          (matChipInputTokenEnd)="addChip($event, 'mandatoryInclusions')"
          class="nom-form__input"
        />
        <mat-autocomplete #mandatoryInclusionAutocomplete="matAutocomplete">
          @for (ingredient of (filteredCuratedIngredients | async); track
          ingredient) {
          <mat-option
            [value]="ingredient"
            (click)="
              addChip({ input: null, value: ingredient }, 'mandatoryInclusions')
            "
          >
            {{ ingredient }}
          </mat-option>
          }
        </mat-autocomplete>
      </mat-form-field>

      <mat-form-field appearance="outline" class="nom-form__field">
        <mat-label>Fasting Schedules</mat-label>
        <textarea
          matInput
          [formControlName]="'fastingSchedules'"
          placeholder="e.g., Every Friday, Lent"
        ></textarea>
      </mat-form-field>
    </div>
    } @case (RestrictionTypeEnum.AllergyMedical) {
    <div class="nom-section mt-4">
      <h4 class="nom-section__subheading">Allergies & Medical Restrictions</h4>
      <p class="nom-instruction-text">
        Indicate any allergies or health conditions.
      </p>

      <mat-form-field appearance="outline" class="nom-form__field">
        <mat-label>Allergies (Ingredients)</mat-label>
        <mat-select
          [formControlName]="'allergyMedicalIngredientIds'"
          multiple
          (selectionChange)="
            onMultiSelectChange('allergyMedicalIngredientIds', $event)
          "
          [value]="allergyMedicalIngredientIdsArray.value"
        >
          @for (allergy of allergyOptions; track allergy.id) {
          <mat-option [value]="allergy.name">{{ allergy.name }}</mat-option>
          }
        </mat-select>
      </mat-form-field>

      <h5 class="nom-section__heading mt-4">Medical Conditions</h5>
      <p class="nom-instruction-text">
        Select any relevant medical conditions.
      </p>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-2 mb-4">
        @for (condition of allergyMedicalConditions; track condition.id) {
        <mat-checkbox
          [checked]="
            isMultiSelectOptionSelected(
              'allergyMedicalConditionIds',
              condition.id
            )
          "
          (change)="
            onCheckboxChange(
              'allergyMedicalConditionIds',
              condition.id,
              $event.checked
            )
          "
          class="nom-checkbox"
        >
          {{ condition.name }}
        </mat-checkbox>
        }
      </div>

      <h5 class="nom-section__heading mt-4">Gastrointestinal Conditions</h5>
      <mat-form-field appearance="outline" class="nom-form__field">
        <mat-label>Select GI Conditions</mat-label>
        <mat-select
          [formControlName]="'gastrointestinalConditions'"
          multiple
          (selectionChange)="
            onMultiSelectChange('gastrointestinalConditions', $event)
          "
          [value]="gastrointestinalConditionsArray.value"
        >
          @for (condition of gastrointestinalConditionsOptions; track
          condition.id) {
          <mat-option [value]="condition.id">{{ condition.name }}</mat-option>
          }
        </mat-select>
      </mat-form-field>

      <h5 class="nom-section__heading mt-4">Kidney Disease Restrictions</h5>
      <p class="nom-instruction-text">
        Select any nutrients restricted for kidney disease.
      </p>
      <mat-form-field appearance="outline" class="nom-form__field">
        <mat-label>Nutrient Restrictions</mat-label>
        <mat-select
          [formControlName]="'kidneyDiseaseNutrientRestrictions'"
          multiple
          (selectionChange)="
            onMultiSelectChange('kidneyDiseaseNutrientRestrictions', $event)
          "
          [value]="kidneyDiseaseNutrientRestrictionsArray.value"
        >
          @for (restriction of kidneyDiseaseRestrictionsOptions; track
          restriction) {
          <mat-option [value]="restriction">{{ restriction }}</mat-option>
          }
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline" class="nom-form__field">
        <mat-label>Vitamin/Mineral Deficiencies</mat-label>
        <mat-chip-grid
          #micronutrientChipGrid
          aria-label="Vitamin/Mineral Deficiencies"
        >
          @for (item of vitaminMineralDeficienciesArray.controls; track item) {
          <mat-chip-row
            (removed)="removeChip(item.value, 'vitaminMineralDeficiencies')"
          >
            {{ item.value }}
            <button matChipRemove [attr.aria-label]="'Remove ' + item.value">
              <mat-icon>cancel</mat-icon>
            </button>
          </mat-chip-row>
          }
        </mat-chip-grid>
        <input
          placeholder="Search nutrients..."
          [formControl]="micronutrientSearchControl"
          [matChipInputFor]="micronutrientChipGrid"
          [matAutocomplete]="micronutrientAutocomplete"
          (matChipInputTokenEnd)="addChip($event, 'vitaminMineralDeficiencies')"
          class="nom-form__input"
        />
        <mat-autocomplete #micronutrientAutocomplete="matAutocomplete">
          @for (nutrient of (filteredMicronutrients | async); track nutrient) {
          <mat-option
            [value]="nutrient"
            (click)="
              addChip(
                { input: null, value: nutrient },
                'vitaminMineralDeficiencies'
              )
            "
          >
            {{ nutrient }}
          </mat-option>
          }
        </mat-autocomplete>
      </mat-form-field>

      <mat-form-field appearance="outline" class="nom-form__field">
        <mat-label>Prescription Interactions</mat-label>
        <textarea
          matInput
          [formControlName]="'prescriptionInteractions'"
          placeholder="List any medications that may interact with diet"
        ></textarea>
      </mat-form-field>
    </div>
    } @case (RestrictionTypeEnum.PersonalPreference) {
    <div class="nom-section mt-4">
      <h4 class="nom-section__subheading">Personal Preferences</h4>
      <p class="nom-instruction-text">
        Customize your plan with your preferences.
      </p>

      <mat-form-field appearance="outline" class="nom-form__field">
        <mat-label>Preferred Spice Level</mat-label>
        <mat-select [formControlName]="'personalPreferenceSpiceLevel'">
          @for (level of spiceLevelOptions; track level) {
          <mat-option [value]="level">{{ level }}</mat-option>
          }
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline" class="nom-form__field">
        <mat-label>Disliked Ingredients</mat-label>
        <mat-chip-grid
          #dislikedIngredientsChipGrid
          aria-label="Disliked Ingredients"
        >
          @for (item of dislikedIngredientsArray.controls; track item) {
          <mat-chip-row
            (removed)="removeChip(item.value, 'dislikedIngredients')"
          >
            {{ item.value }}
            <button matChipRemove [attr.aria-label]="'Remove ' + item.value">
              <mat-icon>cancel</mat-icon>
            </button>
          </mat-chip-row>
          }
        </mat-chip-grid>
        <input
          placeholder="New disliked ingredient..."
          [formControl]="ingredientSearchControl"
          [matChipInputFor]="dislikedIngredientsChipGrid"
          [matAutocomplete]="dislikedIngredientAutocomplete"
          (matChipInputTokenEnd)="addChip($event, 'dislikedIngredients')"
          class="nom-form__input"
        />
        <mat-autocomplete #dislikedIngredientAutocomplete="matAutocomplete">
          @for (ingredient of (filteredCuratedIngredients | async); track
          ingredient) {
          <mat-option
            [value]="ingredient"
            (click)="
              addChip({ input: null, value: ingredient }, 'dislikedIngredients')
            "
          >
            {{ ingredient }}
          </mat-option>
          }
        </mat-autocomplete>
      </mat-form-field>

      <mat-form-field appearance="outline" class="nom-form__field">
        <mat-label>Disliked Textures</mat-label>
        <mat-select
          [formControlName]="'dislikedTextures'"
          multiple
          (selectionChange)="onMultiSelectChange('dislikedTextures', $event)"
          [value]="dislikedTexturesArray.value"
        >
          @for (texture of texturesDislikedOptions; track texture) {
          <mat-option [value]="texture">{{ texture }}</mat-option>
          }
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline" class="nom-form__field">
        <mat-label>Preferred Cooking Methods</mat-label>
        <mat-select
          [formControlName]="'preferredCookingMethods'"
          multiple
          (selectionChange)="
            onMultiSelectChange('preferredCookingMethods', $event)
          "
          [value]="preferredCookingMethodsArray.value"
        >
          @for (method of preferredCookingMethodsOptions; track method) {
          <mat-option [value]="method">{{ method }}</mat-option>
          }
        </mat-select>
      </mat-form-field>
    </div>
    } @default {
    <p class="nom-message-text">No restriction type selected or supported.</p>
    } }

    <!-- Conditional Allocation section (Replaced with form-driven logic) -->
    <!-- Removed previous conditional allocation HTML structure as it seems complex and might be replaced by the `appliesToEntirePlan` and `affectedPersonIds` logic. -->
    <!-- If specific allocation logic UI is still needed beyond basic multi-select, it needs re-evaluation based on desired UI. -->
    <div *ngIf="false">
      <!-- This entire section seems to be a placeholder for complex dynamic allocation.
             Based on the `appliesToEntirePlan` and `affectedPersonIds` FormArray,
             much of this might be implicitly handled.
             If not, this section needs explicit definition in the TS.
        -->
    </div>
  </div>
</form>
